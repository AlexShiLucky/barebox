#!/bin/sh

verbose=
dryrun=

usage="
$0 [OPTIONS] [source]\n
 -v  verbose\n
 -d  dryrun\n
 -l  list boot sources\n
 -h  help"

. /env/data/ansi-colors

for i in /env/boot/*; do
	basename $i s
	sources="$sources$s "
done

if [ -d /env/boot.d ]; then
	sources="$sources\n\nboot sequence:"
	for i in /env/boot.d/*; do
		readlink -f $i s
		basename $s link
		basename $i s
		sources="$sources\n ${YELLOW}${s}${NC} -> ${CYAN}${link}${NC}"
	done
	sequence=y
else
	sources="$sources\n\nboot sequence:\nnone"
	echo -e "${RED}WARNING: boot sequence: none${NC}"
	sequence=n
fi

while getopt "vdhl" opt; do
	if [ ${opt} = v ]; then
		if [ -n "$verbose" ]; then
			verbose="-v -v"
		else
			verbose="-v"
		fi
	elif [ ${opt} = d ]; then
		dryrun="-d"
	elif [ ${opt} = l ]; then
		echo -e "boot sources:\n$sources"
		exit 0
	elif [ ${opt} = h ]; then
		echo -e "$usage"
		exit 0
	fi
done

# clear linux.bootargs.dyn.* and bootm.*
global -r linux.bootargs.dyn.
global -r bootm.

if [ $# != 0 ]; then
	sequence=n
fi

if [ "$sequence" = y ]; then
	if [ ! -d /env/boot.d ]; then
		echo -e "${GREEN}boot sequence ${RED}none${NC}"
		exit 1
	fi
	echo -e "${GREEN}Start boot sequence${NC}"
	for i in /env/boot.d/*; do
		readlink -f $i s
		basename $s link
		basename $i s
		msg="${GREEN}boot${NC} ${YELLOW}${s}${NC} -> ${CYAN}${link}${NC}"
		echo -e "${msg}"
		boot $dryrun $s
		echo -e "${msg} ${RED}failled${NC}"
		ret=$?
	done
	echo -e "${GREEN}boot sequence ${RED}failed${NC}"
	exit $ret
else
	file=$1
	scr=
	echo -e "${GREEN}booting ${YELLOW}$file${NC}"
	[ -f /env/boot.d/$file ] && scr=/env/boot.d/$file
	[ -f /env/boot/$file ] && scr=/env/boot/$file

	if [ -z "$scr" ]; then
		echo -e "/env/boot/$file or /env/boot.d/$file does not exist. Valid choices:\n$sources"
		exit
	fi
	$scr
fi

if [ -n "$dryrun" ]; then
	exit 0
fi

bootm $verbose
